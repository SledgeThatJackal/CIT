<div th:replace="~{fragments/headerFragment::headerFragment}"></div>

<form th:if="${container != null}" th:object="${container}" th:action="@{${'/container' + (isEdit ? '/edit' : '/create')}}" method="post">
    <input type="hidden" th:field="*{id}"/>
    <div class="mb-3">
        <label for="containerName" class="form-label">Name</label>
        <input type="text" class="form-control" id="containerName" th:field="*{name}">
    </div>
    <div class="mb-3">
        <label for="containerDescription" class="form-label">Description</label>
        <input type="text" class="form-control" id="containerDescription" th:field="*{description}">
    </div>
    <div class="mb-3">
        <label for="scannerId" class="form-label">Scanner ID</label>
        <input type="text" class="form-control" id="scannerId" th:field="*{scannerId}">
    </div>
    <div class="mb-3">
        <label for="parentContainerId" class="form-label">Parent Container ID</label>
        <input type="number" class="form-control" id="parentContainerId" th:field="*{parentContainer}">
    </div>
    <input type="hidden" th:field="*{containerItems}"/>
    <button type="submit" class="btn btn-primary" th:text="${isEdit ? 'Update' : 'Create'}"></button>
</form>

<form th:if="${itemCreationDTO != null}" th:object="${itemCreationDTO}" th:action="@{${'/item' + (isEdit ? '/edit' : '/create')}}" method="post">
    <input type="hidden" th:field="*{item.id}"/>
    <div class="mb-3">
        <label for="itemName" class="form-label">Name</label>
        <input type="text" class="form-control" id="itemName" th:field="*{item.name}" required>
    </div>
    <div class="mb-3">
        <label for="itemDescription" class="form-label">Description</label>
        <input type="text" class="form-control" id="itemDescription" th:field="*{item.description}">
    </div>
    <table id="linkTable" class="table table-secondary table-hover table-striped">
        <thead>
            <tr>
                <th scope="col"></th>
                <th scope="col">Scanner ID</th>
                <th scope="col">Quantity</th>
                <th scope="col">Remove</th>
            </tr>
        </thead>
        <tbody id="linkTableBody">
            <tr th:each="link, iterStat : *{links}" id="containerRow" th:attr="data-id=${link.id}" class="link">
                <th th:text="${iterStat.index + 1}"></th>
                <td id="scannerIdInput">
                    <input th:field="*{links[__${iterStat.index}__].scannerId}" type="text" class="form-control input" th:disabled="${link.id != null}"/>
                </td>
                <td id="quantityInput">
                    <input th:field="*{links[__${iterStat.index}__].quantity}" type="number" class="form-control" />
                </td>
                <td>
                    <button type="button" class="btn-close" aria-label="Close"></button>
                </td>
                <input type="hidden" th:field="*{links[__${iterStat.index}__].id}"/>
            </tr>
        </tbody>
    </table>

    <input type="hidden" th:field="*{item.containerItems}"/>
    <button type="submit" class="btn btn-primary" th:text="${isEdit ? 'Update' : 'Create'}"></button>
</form>

<style>
    [required] {
        border: 2px solid red;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        if(window.location.href.indexOf("container") > -1){
            return;
        }

        var lastInput = document.querySelector('#linkTableBody:last-child #scannerIdInput');
        var rowToDuplicate = document.getElementById('containerRow');
        var numberOfRows = document.getElementById('linkTableBody').children.length;
        var table = document.getElementById('linkTableBody');

        lastInput.addEventListener('input', cloneRow);

        if(numberOfRows > 1){
            lastInput.dispatchEvent(new Event('input', {bubbles: true}));
        }

        function cloneRow(){
            var newRow = rowToDuplicate.cloneNode(true);
            numberOfRows++;

            newRow.removeAttribute('id');
            newRow.removeAttribute('data-id');
            newRow.querySelector('th').textContent = numberOfRows;

            var scannerIdInput = newRow.querySelector('#scannerIdInput input');
            scannerIdInput.value = '';
            scannerIdInput.removeAttribute('disabled');
            scannerIdInput.addEventListener('input', cloneRow);
            scannerIdInput.id = 'links' + (numberOfRows - 1) + '.scannerId';
            scannerIdInput.name = 'links[' + (numberOfRows - 1) + '].scannerId';

            var quantityInput = newRow.querySelector('#quantityInput input');
            quantityInput.id = 'links' + (numberOfRows - 1) + '.quantity';
            quantityInput.name = 'links[' + (numberOfRows - 1) + '].quantity';

            newRow.querySelector('#scannerIdInput').id = 'scannerIdInput' + (numberOfRows - 1);
            newRow.querySelector('#quantityInput').id = 'quantityInput' + (numberOfRows - 1);

            table.appendChild(newRow);

            this.removeEventListener('input', cloneRow);
        }

        table.addEventListener('click', function(e) {
            if(e.target.matches('button.btn-close')){
                const link = e.target.closest('.link');
                const linkId = link.getAttribute('data-id');
                deleteLink(link, linkId);
            }
        });

        function deleteLink(link, linkId){
            if(linkId === null){
                if(numberOfRows > 1) deleteRow(link);

                return;
            }

            fetch('/item/delete-link', {
                method: 'POST',
                headers: {
                    'Content-Type' : 'application/json'
                },
                body: linkId
            })
            .then(response => {
                if(response.ok){
                    if(link){
                        deleteRow(link);
                    }
                }
            });
        }

        function deleteRow(link){
            link.remove();
            numberOfRows--;

            if(numberOfRows === 0) cloneRow();

            table.querySelector(':last-child').addEventListener('input', cloneRow);

            var rows = table.getElementsByTagName('tr');

            for(var i = 0; i < rows.length; i++){
                rows[i].getElementsByTagName('th')[0].innerText = i + 1;
            }
        }
    });
</script>

<div th:replace="~{fragments/footerFragment::footerFragment}"></div>